# Banana Ripeness Classification

Проект решает задачу разделения бананов по спелости при помощи фото, так как
вручную разделять долго и дорого. Для этого используется признаки предобученной
модели CLIP и классификатор на базе PyTorch Lightning.

## 1 Описание

### 1.1 Формат данных

- **Входные данные**: Изображения бананов в формате jpeg. В процессе обучения
  изображения предварительно обрабатываются моделью CLIP для извлечения
  признаков (эмбеддингов).
- **Выходные данные**: Класс спелости банана.

### 1.2 Модель

Используется модель `CachedCLIPClassifier`, которая представляет собой
полносвязную нейронную сеть поверх извлеченных признаков модели CLIP.

### 1.3 Метрики качества

- **Accuracy**: Показывает общую долю правильных предсказаний.
- **Cross-Entropy Loss**: Функция потерь для многоклассовой классификации.

### 1.4 Датасет

Датасет взят с уже разделенными данными на тренировочную, валидационную и
тестовую выборку. Хранится в директории `data` и управляется с помощью DVC.

## 2. Setup

Для настройки окружения и подготовки данных выполните следующие шаги:

### 2.1 Клонирование репозитория

```bash
git clone https://github.com/Andreyabox/banana-ripeness-classification.git
cd banana-ripeness-classification
```

### 2.2 Установка зависимостей

```bash
uv sync
```

### 2.3 Настройка DVC и получение данных:

Данные скачиваются автоматически при первом запуске обучения. Нужно только ввести
ключи для доступа
```bash
  dvc remote modify --local storage access_key_id ВАШ_KEY_ID
  dvc remote modify --local storage secret_access_key ВАШ_SECRET_KEY
```

- В `cache_features.py` вызывается команда `dvc pull`
- DVC автоматически загружает файлы и папки в папку `data/` из S3/Yandex Object
  Storage

### 2.4 Запуск всех pre-commit хуков

```bash
uv run pre-commit install
uv run pre-commit run --all-files
```

## 3. Train

Тренировка модели состоит из двух этапов: кэширование признаков и обучение
модели.

### 3.1 Кэширование признаков CLIP

Для ускорения обучения сначала необходимо извлечь признаки из всех изображений и
сохранить их локально:

```bash
.venv\Scripts\activate
python commands.py command=cache-features
```

Работает, если есть папки train, validation, test с изображениями в папке data.

### 3.2 Запуск обучения модели

После того как признаки закэшированы, запустите обучение:

```bash
python commands.py command=train-cached train.epochs=20 train.batch_size=128
```

### 3.3 Experiment Tracking

Для логирования метрик и гиперпараметров используется **MLflow**. По умолчанию
сервер должен быть запущен по адресу `http://127.0.0.1:8080`.
